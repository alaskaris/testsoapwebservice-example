# Integration Testing with WebApplicationFactory in ASP.NET Core

This guide demonstrates how to set up integration tests for an ASP.NET Core application using `WebApplicationFactory`. 
This is particularly useful for testing SOAP services implemented with SoapCore.

## Background
The `WebApplicationFactory` class allows us to create a test server that hosts your application, enabling you to send 
HTTP requests and verify responses in a controlled environment. This server is run in memory, making it very efficient 
for testing. 

To send requests to the test server, we must use the HttpClient instance that `WebApplicationFactory` provides. This 
client is configured to communicate with the in-memory server, ensuring that all requests are routed correctly. 

## Problem
While this is straightforward for RESTful services, SOAP services require additional handling to format requests and parse 
responses. The `SoapCore` library that is used to implement SOAP services in ASP.NET Core, does not use an `HttpClient` 
internally and thus, it does not natively support integration testing with `WebApplicationFactory`.

The SOAP client generated by tools like `dotnet-svcutil` or Visual Studio's Connected Services feature typically 
uses bindings like BasicHttpBinding, WSHttpBinding, etc., which internally rely on `HttpClientHandler` and not `HttpClient`.
To test SOAP services with `WebApplicationFactory`, we need to create a custom `HttpMessageHandler` that can intercept
HTTP requests and route them to the in-memory server. The custom handler will use the `HttpClient` provided by 
`WebApplicationFactory` to send requests to the test server and will be injected using a custom behavior in the SOAP client.

## Solution

We implemented a mechanism to intercept WCF SOAP client HTTP requests and redirect them through a custom HttpClient 
(typically from WebApplicationFactory for testing).

### How it works:

- We already have an `HttpClient` instance from `WebApplicationFactory`. 
- We create a custom `HttpMessageHandler` that forwards requests to this `HttpClient` ([View the source code](./InterceptingHttpMessageHandler.cs)).
- Then, we define a custom `IEndpointBehavior` that injects this handler into the WCF client's HTTP pipeline. ([View the source code](./HttpMessageHandlerBehavior.cs)).
- Finally, we provide an extension method to easily apply this behavior to any WCF service endpoint. ([View the source code](./ServiceEndpointExtensions.cs)).

So:
1. `ServiceEndpointExtensions.InterceptRequestsWithHttpClient()` - Extension method that adds the custom behavior to a 
WCF service endpoint
2. `HttpMessageHandlerBehavior` - Implements `IEndpointBehavior` to inject a custom `HttpMessageHandler` into the WCF 
client's HTTP pipeline via `AddBindingParameters()`
3. `InterceptingHttpMessageHandler` - A `DelegatingHandler` that intercepts all outgoing HTTP requests and routes them 
through the provided `HttpClient` instead of using the default handler

**Result**: When you call `endpoint.InterceptRequestsWithHttpClient(testClient)`, all HTTP requests from that WCF client 
go through the test client instead of making real network calls. This enables in-memory testing with `WebApplicationFactory`.

## **References**
- [How do I integration test a SoapCore endpoint?](https://stackoverflow.com/questions/66338805/how-do-i-integration-test-a-soapcore-endpoint)
- https://stackoverflow.com/a/66357030